<!--
	作者：369126371@qq.com
	时间：2016-10-26
	描述：部门调剂申请单
-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>部门调剂</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/common.css" />
	</head>
<style>
	.mui-content{
		background:#fff;
		overflow: auto;
	}
	.mui-table-view-cell:after {
		position: absolute;
		right: 0;
		bottom: 0;
		left: 0px;
		height: 1px;
		content: '';
		-webkit-transform: scaleY(.5);
		transform: scaleY(.5);
		background-color: #DCDCDC;				
	}
	.mui-table-view-cell{
		color: #676767;
		font-size: 14px;
	}
	.lititle{
		width: 100%;
		font-size: 14px;
	}
	.lidivone{
		width: 90px;
		text-align: right;
		float: left;
	}
	.lidivtwo{
		width: calc(100% - 90px);
		float: left;
	}
	.lidivtwo input{
		font-size: 14px;
	}
	
	.buttondiv{
		width: 100%;
		height: 50px;
	}
	.buttonwebs{
		width: 98%;
		margin-left: 1%;
		height: 45px;
		background-color: rgb(44,195,255);
		color: #FFFFFF;
		font-size: 18px;
		letter-spacing: 5px;
		border: 1px solid rgb(90,200,255);
	}
	
	.inputluru{
		width: 90%;
		border: 1px #CCCCCC solid;
	}
	#thelistul{
		padding: 5px;
	}
	input[type=text]{
		margin-bottom: 0px;
		height: 25px;
		line-height: 20px;
	}
	.stdcode,.recid{
		display: none;
	}
	.title{
		margin-top:5px ;
		width: 100%;
		text-align: center;
		font-size: 14px;
		color: #FFFFFF;
		background-color: rgb(44,195,255);.
		line-height: 50px;
		padding-top: 5px;
	}
	
	.redbixu{
		color: red;
	}
	.plusandjian{
		float: left;
		height: 16px;
		width: 16px;
		border-radius: 8px;
		font-weight: 700;
		color: #FFFFFF;
		background-color: #666666;
		text-align: center;
		line-height: 16px;
		margin-right: 10px;
	}
		</style>
	</head>
	<body>
		<header id="header" class="mui-bar mui-bar-nav gams-header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">部门调剂申请单</h1>
		</header>
		<div class="mui-content">
			<div class="mui-content-padded" style="margin: 5px;">
				<ul class="mui-table-view" id="thelistul">
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">记账日期<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="JIZRQ" readonly="readonly" type="text" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">调剂日期<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="BILLTIME" readonly="readonly" type="text" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">调出部门<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru" id="diaocbmmc" type="text" readonly="readonly" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell" style="display: none;">
						<div class="lititle">
							<div class="lidivone">调出部门</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="BIZ_JY00_DIAOCBM" type="text"  /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">调入部门<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru" id="diaorbmmc" type="text" readonly="readonly" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell" style="display: none;">
						<div class="lititle">
							<div class="lidivone">调入部门</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="BIZ_JY00_DIAORBM" type="text"  /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">经办人<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="JINGBR" type="text"  /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">调入责任人<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru" id="lingyongr" type="text" readonly="readonly" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell" style="display: none;">
						<div class="lititle">
							<div class="lidivone">调入责任人</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="BIZ_JY00_LINGYR" type="text" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">使用方向<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru" id="shiyfx" type="text" readonly="readonly" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell" style="display: none;">
						<div class="lititle">
							<div class="lidivone">使用方向</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="BIZ_JY00_SHIYFXID" type="text" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">使用性质<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru" id="shiyxz" type="text" readonly="readonly" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell" style="display: none;">
						<div class="lititle">
							<div class="lidivone">使用性质</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="BIZ_JY00_SHIYXZID" type="text" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">存放地点<span class="redbixu">*</span>：</div>
							<div class="lidivtwo"><input class="inputluru" id="cunfdd" type="text" readonly="readonly" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell" style="display: none;">
						<div class="lititle">
							<div class="lidivone">存放地点</div>
							<div class="lidivtwo"><input class="inputluru qdht required" id="BIZ_JY00_CUNFDDID" type="text" /></div>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="lititle">
							<div class="lidivone">备注：</div>
							<div class="lidivtwo">
								<textarea id="BEIZ" class="qdht" rows="2" cols="3"></textarea>
							</div>
						</div>
					</li>
					<li class="mui-table-view-cell" id="clickCard">
						<span style="font-size: 16px; font-weight: 700;">待调剂明细表：</span>
					</li>
				</ul>
				<div class="buttondiv">
					<button class="buttonwebs" id="comtodnaButton">提交审核</button>
				</div>
			</div>
		</div>
		
		<script src="../../js/jquery-1.11.3.js"></script>
		<script type="text/javascript" src="../../js/jqzw_server.js" ></script>
		<script type="text/javascript" src="../../js/mui.min.js" ></script>
		<script type="text/javascript" src="../../js/laydate/laydate.js" ></script>
		<script type="text/javascript" src="../../js/layer/layer.js" ></script>
		<script type="text/javascript" src="../../js/Util.js"></script>
		<script type="text/javascript">
		window.addEventListener('refreshPerson', function(event) {
			if(event.detail.selectprorecid != "") {
				$("#lingyongr").val(event.detail.selectperson);
				$("#BIZ_JY00_LINGYR").val(event.detail.selectpersonid);
			}
		});
		
		window.addEventListener('refreshAddress',function(event){
			// 刷新存放地点;
		  	if(event.detail.selectaddrecid != ""){
			  	$("#cunfdd").val(event.detail.selectaddress);
			  	$("#BIZ_JY00_CUNFDDID").val(event.detail.selectaddrecid);
		  	}
		});
		
		mui.init({
			beforeback: function(){
				//获得列表界面的webview
				var ScanCreateDan = plus.webview.getWebviewById('ScanCreateDan');
				//触发列表界面的自定义事件（refresh）,从而进行数据刷新
				mui.fire(ScanCreateDan,'refresh');
				//返回true，继续页面关闭逻辑
				return true;
			}
		});
		
		mui.plusReady(function(){
			var DepartmentSwap = plus.webview.currentWebview();
			var assetcards = DepartmentSwap.assetcards;
			document.getElementById("diaocbmmc").value = DepartmentSwap.diaochubm;
			document.getElementById("BIZ_JY00_DIAOCBM").value = DepartmentSwap.diaochubmid;
			document.getElementById("diaorbmmc").value = DepartmentSwap.diaorubm;
			document.getElementById("BIZ_JY00_DIAORBM").value = DepartmentSwap.diaorubmid;
			setDivAssetCard(assetcards);
			
			document.getElementById("lingyongr").addEventListener('tap', function() {
				mui.openWindow({
					url: "../basedata/selectPerson.html",
					id: 'selectPerson',
					styles: {
						popGesture: 'close',
						scrollIndicator: "none"
					},
					waiting: {
						autoShow: false
					},
					extras: {
						hrefid: plus.webview.currentWebview().id,
						callback: 'refreshPerson'
					}
				});
			});
			
			document.getElementById("cunfdd").addEventListener('tap', function() {
				mui.openWindow({
					url: "../basedata/selectAddress.html",
					id: 'selectAddress',
					styles: {
						popGesture: 'close',
						scrollIndicator: "none"
					},
					waiting: {
						autoShow: false
					},
					extras: {
						hrefid: plus.webview.currentWebview().id,
						callback: 'refreshAddress'
					}
				});
			});
		});
		
		$(function(){
			var dd = new Date();
			var y = dd.getFullYear();
			var m = dd.getMonth()+1;//获取当前月份的日期
			if(m<10){
				m="0"+m.toString()
			}
			var d = dd.getDate(); 
			if(d<10){
				d="0"+d.toString()
			}
			var currentDate = y+"-"+m+"-"+d;
			$('#JIZRQ').val(currentDate);
			$("#BILLTIME").val(currentDate);
			
			document.getElementById("shiyxz").addEventListener('tap', function() {
				$jqzw_server.callServer('SDSFDXDepartmentMove','getBaseDate', 'BIZ_JY00_GAMS_JC_SHIYXZ').success(function(iv){
					createBaseData('shiyxz-select', iv);
					addShiyxzListener();
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					mui.toast("会话过久，可重新进行上次操作");
				});
			});
			
			function addShiyxzListener() {
				mui('#shiyxz-select').on('tap', '.title', function() {
					$("#shiyxz").val($(this).text());
					$("#BIZ_JY00_SHIYXZID").val($(this).siblings(".recid").text());
					layer.closeAll();
				});
			}
			
			document.getElementById("shiyfx").addEventListener('tap', function() {
				$jqzw_server.callServer('SDSFDXDepartmentMove','getBaseDate', 'BIZ_JY00_GAMS_JC_JIAOYUSAGE').success(function(iv){
					createBaseData('shiyfx-select', iv);
					addShiyFXListener();
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					mui.toast("会话过久，可重新进行上次操作");
				});
			});
			
			function addShiyFXListener() {
				mui('#shiyfx-select').on('tap', '.title', function() {
					$("#shiyfx").val($(this).text());
					$("#BIZ_JY00_SHIYFXID").val($(this).siblings(".recid").text());
					layer.closeAll();
				});
			}
			
			$("#comtodnaButton").click(function(){
				var togo = true;
				var AssetDisposal ={};
				var checkItems = $(".qdht");
				for(var i=0; i<checkItems.length; i++) {
					if($(checkItems[i]).hasClass('required') && $(checkItems[i]).val() == '') {
						var tiptext = $(checkItems[i]).parent().siblings(".lidivone").text();
						mui.toast(tiptext+"不能为空！");
						return false;
					}
					var shuxing = $(checkItems[i]).attr("id");
					AssetDisposal[shuxing] = replaceReturn($(checkItems[i]).val());
				}
				// TODO 提交部门调剂单 后台报错
				var Assetsjson = "{"+"'AssetDisposal':'"+JSON.stringify(AssetDisposal)+"','AssetCards':'"+JSON.stringify(assetcardsnew)+"'}";
				console.log(JSON.stringify(Assetsjson));
				$jqzw_server.callServer('SDSFDXDepartmentMove','saveDepartmentMove', Assetsjson).success(function(iv){
					if(iv == 'false' || iv == false){
						mui.toast("提交失败！");
						return false;
					}else{
						mui.toast("保存成功！");
						var page = plus.webview.getWebviewById('BmSwapScan');
						mui.fire(page,'clear');
						mui.back();
					}
				}).error(function(iv){
					mui.toast(iv.substring(5))
					console.log(iv);
				});
			});
		});
		
		;!function(){
			laydate.skin('yalan');
			laydate({
			   elem: '#BILLTIME',
			   isclear: false, //是否显示清空
			   issure: false //是否显示确定
			});
			laydate({
			   elem: '#JIZRQ',
			   isclear: false, //是否显示清空
			   issure: false //是否显示确定
			});
		}();
		
		function createBaseData(id, datas) {
			var contentDiv = '<div id="'+ id +'">';
			for(i in datas){
				contentDiv = contentDiv+'<div class="bd_item">'
					+'<div class="title">'+datas[i].stdname+'</div>'
					+'<div class="recid">'+datas[i].recid+'</div>'
					+'<div class="stdcode">'+datas[i].stdcode+'</div>'
					+'</div>';
			}
			contentDiv+= '</div>'
			layer.open({
			    type: 1,
			    content: contentDiv,
			    anim: true,
			    style: 'position:fixed; bottom:0; left:0; width:100%; padding:10px 0; border:none;'
			});
		}
		
		function createDivtoShow(){
			var opencheckhtmls = '<div id="checkboxcontent">'+$("#checkitemDiv").html()+'</div>'
			layer.open({
			    content: opencheckhtmls,
			});
		}
		
		var assetcardsnew = [];
		function setDivAssetCard(assetcards){
			var gudingzichan = 0;
			var wuxingzichan = 0;
			for(var i in assetcards){
				var objnew = new Object();
				objnew["recid"] = assetcards[i].recid;
				objnew["billdefine"] = assetcards[i].billdefine;
				objnew["objectid"] = assetcards[i].objectid;
				assetcardsnew.push(objnew);
				var dateriq = new Date(assetcards[i].qudrq);
				var y = dateriq.getFullYear();
				var m = dateriq.getMonth()+1;//获取当前月份的日期
				if(m<10){
					m="0"+m.toString()
				}
				var d = dateriq.getDate(); 
				if(d<10){
					d="0"+d.toString();
				}
				var dateriqi = y+"-"+m+"-"+d;
				$("#thelistul").append('<div class="mui-card" style="margin:5px" id="assetcards'+i+'"><ul class="mui-table-view"><li class="mui-table-view-cell mui-collapse"><a class="mui-navigate-right" href="#"><div class="plusandjian">+</div>'+assetcards[i].zicbh+" "+assetcards[i].zicmc+'</a><div class="mui-collapse-content"><div class="lititle"><div class="sumdiv" id="zhanshidivshow"><ul class="mui-table-view"><li class="mui-table-view-cell zicbh"><div class="lititle"><div class="lidivone">资产编号：</div><div class="lidivtwo">'+assetcards[i].zicbh+'</div></div></li><li class="mui-table-view-cell zicmc"><div class="lititle"><div class="lidivone">资产名称：</div><div class="lidivtwo">'+assetcards[i].zicmc+'</div></div></li><li class="mui-table-view-cell classgbmc"><div class="lititle"><div class="lidivone">资产大类：</div><div class="lidivtwo">'+assetcards[i].classgbmc+'</div></div></li><li class="mui-table-view-cell zicflbt"><div class="lititle"><div class="lidivone">资产分类：</div><div class="lidivtwo">'+assetcards[i].zicflbt+'</div></div></li><li class="mui-table-view-cell pinp"><div class="lititle"><div class="lidivone">资产品牌：</div><div class="lidivtwo">'+assetcards[i].pinp+'</div></div></li><li class="mui-table-view-cell guigxh"><div class="lititle"><div class="lidivone">规格型号：</div><div class="lidivtwo">'+assetcards[i].guigxh+'</div></div></li><li class="mui-table-view-cell jiaz"><div class="lititle"><div class="lidivone">价值：</div><div class="lidivtwo">'+assetcards[i].jiaz+'</div></div></li><li class="mui-table-view-cell shul"><div class="lititle"><div class="lidivone">责任人：</div><div class="lidivtwo">'+assetcards[i].shiyr+'</div></div></li><li class="mui-table-view-cell dateriqi"><div class="lititle"><div class="lidivone">取得日期：</div><div class="lidivtwo">'+dateriqi+'</div></div></li><li class="mui-table-view-cell ziclbmc"><div class="lititle"><div class="lidivone">资产类别：</div><div class="lidivtwo">'+assetcards[i].ziclbmc+'</div></div></li></ul></div></div></div></li></ul></div>')
			}
			
			$("#gudzcyz").text(gudingzichan);
			$("#wuxzcyz").text(wuxingzichan);
		}
			
		</script>
	</body>

</html>