<!--
	作者：宋超
	时间：2016-10-26
	描述：资产入账
-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>扫码取卡</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8"/>
	</head>
<style>
	body,html{
		background:#fff;
	}
	.mui-content{
		background:#fff;
	}
	.headcount{
		background-color: rgb(44,195,255);
	}
	
	.inputrow label {
		font-family: 'Helvetica Neue',Helvetica,sans-serif;
		line-height: 1.1;
		float: right;
		width: 25%;
		padding: 10px 15px;
		height: 40px;
		border-top-right-radius:10px;
		border-bottom-right-radius:10px;
		border: 1px solid rgb(44,195,255); 
	}
	.inputrow {
		border: solid 0px #CCCCCC;
		width: 95%;
		border-radius: 10px;
	}
	.inputrow input {
		width: 75%;
		margin-bottom: 0;
		padding-left: 0;
		border: 1px solid #CCCCCC; 
		border-top-left-radius:10px;
		border-bottom-left-radius:10px;
		border-top-right-radius:0px;
		border-bottom-right-radius:0px;
	}
	.asset-infos {
	    padding: 0px;
	    margin: 10px;
	    background: #fff;
	    border: 1px solid #ddd;
	    -webkit-border-radius: 3px;
	    border-radius: 3px;
	}
	.asset-info {
		overflow: hidden;
	    padding: 10px;
	    border-bottom: inset 1px #ebebeb;
	    vertical-align: middle;
	}
	.asset-info:last-child {
	    border-bottom: inset 0px #ebebeb;
	}
	.clear {
		clear: both;
	}
	.asset-info-left {
		float: left;
		width: calc(100% - 50px);
	}
	.asset-info-left .info {
		width: 100%;
	}
	.info .info-title {
		display: inline-block;
		width: 80px;
	}
	.info-value {
		display: inline-block;
		width: calc(100% - 80px);
	}
	.asset-info-right {
		float: right;
		width: 50px;
		height: 100%;
		text-align: center;
	}
	.asset-info-desp {
		font-size: 12px;
		text-align: right;
	}
	#info-cunfdd .asset-info-left {
		width: calc(100% - 100px);
	}
	
	#info-cunfdd .info-title,
	#info-cunfdd .info-value {
		width: 100%;
	}
	
	#info-cunfdd .asset-info-right {
		width: 100px;
	}
	#info-cunfdd .info-img {
		display: inline-block;
		width: 46px;
	}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav headcount">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;">
				<span style="font-size: 15px;"></span>
			</a>
			<h1 class="mui-title" style="color: #FFFFFF;" id="headtext">资产卡片信息补充</h1>
		</header>
		<div class="mui-content">
			<div  style="margin-top: 10px;" align="center">
				<div class="inputrow" id="inputrow">
					<label style="background-color:rgb(44,195,255);color:white;text-align: center;" id="searchBy"> 搜索</label>
					<input type="text" id="searchinput"  placeholder="请输入要搜索的资产编号" style="background:url(../../image/icon_ss.png) center left 10px no-repeat;background-size: 20px; padding-left: 40px;font-size: 13px;" list="words" >
					<datalist id="words">
						<option value="TD">
						<option value="FW">
						<option value="TY">
						<option value="JJ">
					</datalist>
				</div>
			</div>
			<div class="asset-infos">
				<div class="asset-info" id="info-cunfdd">
					<div class="asset-info-left">
						<div class="info">
							<span class="info-title">存放地点：</span><span class="info-value" id="cunfddtext"></span>
						</div>
					</div>
					<div class="asset-info-right">
						<div class="info-img" id="scan-cunfdd">
							<img src="../../image/sm_icon.png" style="width: 40px;" />
							<div style="font-size: 12px;">扫一扫</div>
						</div>
						<div class="info-img" id="read-cunfdd">
							<img src="../../image/sm_icon.png" style="width: 40px;" />
							<div style="font-size: 12px;">读一读</div>
						</div>
					</div>
					<div class="asset-info-desp clear">点击扫一扫、读一读获取存放地点</div>
				</div>
			</div>
			<div class="asset-infos">
				<div class="asset-info">
					<div class="asset-info-left">
						<div class="info">
							<span class="info-title">资产编号：</span><span class="info-value" id="zcbhtext"></span>
						</div>
						<div class="info">
							<span class="info-title">资产名称：</span><span class="info-value" id="zcmctext"></span>
						</div>
					</div>
					<div class="asset-info-right" id="scan-asset">
						<img src="../../image/sm_icon.png" style="width: 40px;" />
						<div style="font-size: 12px;">扫一扫</div>
					</div>
					<div class="asset-info-desp clear">点击扫一扫获取资产信息</div>
				</div>
				<div class="asset-info">
					<div class="asset-info-left">
						<div class="info">
							<span class="info-title">出厂号：</span><span class="info-value" id="snhaotext"></span>
						</div>
					</div>
					<div class="asset-info-right" id="scan-sn">
						<img src="../../image/sm_icon.png" style="width: 40px;" />
						<div style="font-size: 12px;">扫一扫</div>
					</div>
					<div class="asset-info-desp clear">点击扫一扫获取出厂号</div>
				</div>
				<div class="asset-info">
					<div class="asset-info-left">
						<div class="info">
							<span class="info-title">规格型号：</span><span class="info-value" id="guigxhtext"></span>
						</div>
					</div>
					<div class="asset-info-right" id="scan-guigxh">
						<img src="../../image/sm_icon.png" style="width: 40px;" />
						<div style="font-size: 12px;">扫一扫</div>
					</div>
					<div class="asset-info-desp clear">点击扫一扫获取规格型号</div>
				</div>
			</div>
			<div class="button button-waring" onclick="cleanHistroy();">清空扫码记录</div>
			<div class="button buttontocreate" style="background-color: rgb(44,195,255);border: 1px solid rgb(72,200,255);" >确定</div>
			<div style="height: 20px;"></div>
		</div>
		<div id="zbhref" style="display: none;"></div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jqzw_server.js" ></script>
		<script type="text/javascript" src="../../js/jquery-1.11.3.js" ></script>
		<script type="text/javascript" src="../../js/common.js" ></script>
		<script type="text/javascript" src="../../js/test.js"></script>
		<script type="text/javascript" src="../../js/nfcty.js"></script>
		<script>
			var aniShow = "pop-in";
			var cunfddobj = null;
			var cardobj = null;
			var snhao = "";
			var guigxh='';
			
			mui.init();
			mui.plusReady(function(){
				var ScanCredit = plus.webview.getWebviewById("ScanCredit");
				
				var zbhref = ScanCredit.zbhref;
				document.getElementById("zbhref").innerText = zbhref;
				setYear();
				
				document.getElementById("scan-asset").addEventListener('tap', function() {
					if(cunfddobj == null) {
						mui.toast('请先扫描存放地点！');
						return;
					}
					clicksacn = "queryinfoscan";
					clicked('../base/barcode_scan.html',true,true);
				});
				document.getElementById("scan-cunfdd").addEventListener('tap', function() {
					clicksacn="cunfddscan";
					clicked('../base/barcode_scan.html',true,true);
				});
				document.getElementById("read-cunfdd").addEventListener('tap', function() {
					readData();
				});
				document.getElementById("scan-sn").addEventListener('tap', function() {
					clicksacn = "snhao";
					clicked('../base/barcode_scan.html',true,true);
				});
				document.getElementById("scan-guigxh").addEventListener('tap', function() {
					clicksacn = "guigxh";
					clicked('../base/barcode_scan.html',true,true);
				});
				
			});
			window.addEventListener("refresh",function(event){
				cardobj = null;
				snhao = "";
				$("#history").html("");
			});
			
			function setYear(){
				var dd = new Date();
				var y = dd.getFullYear();
				$("#words").children("option").each(function(){
					$(this).val($(this).val()+y);
				});
			}
			
			var clicksacn = "";
			$(function(){
				$("#searchBy").click(function(){
					if(cunfddobj == null) {
						mui.toast('请先扫描存放地点！');
						return;
					}
					var zicbh = $("#searchinput").val();
					if(zicbh == ""){
						mui.toast("搜索条件不能为空！");
						return;
					}
					clicksacn="queryinfoscan";
					QueryAssetRecord(zicbh);
				});
				
				$(".buttontocreate").click(function(){
					if(cardobj == null){
						mui.toast("未扫描卡片！");
						return;
					}
					var zbhref = $("#zbhref").text();
					mui.openWindow({
						url: zbhref,
						id:zbhref,
						styles: {
							popGesture: 'close',
							scrollIndicator: "none"
						},
						show: {
							aniShow: aniShow
						},
						waiting: {
							autoShow: false
						},
						extras:{
							cunfddobj : cunfddobj,
						 	cardobj : cardobj,
							snhao : snhao,
							guigxh:guigxh
						}
					});
				});
			});
			
			function __read(intent){
			    var s = "nono";
			    waiting.setTitle('请勿移开标签\n正在读取数据...');
			    var Parcelable = plus.android.importClass("android.os.Parcelable");
			    var tag = intent.getParcelableExtra(NfcAdapter.EXTRA_TAG);
			    s = pluginGetStringSync(tag);
			    QueryCunfdd(s);
			    waiting.close();
			}
			
			//二维码信息获取方法
			function scaned( t, r, f ) {
				if(clicksacn == "cunfddscan"){
					QueryCunfdd(r);
				}else if(clicksacn == "queryinfoscan"){
					QueryAssetRecord(r);
				}else if(clicksacn == "snhao"){
					Snhaoin(r);
				}else if(clicksacn == "guigxh"){
					Guigxh(r);
				}
			}
			
			function Snhaoin(r){
				snhao = r;
				$("#snhaotext").text(r);
			}
			function Guigxh(r){
				guigxh = r;
				$("#guigxhtext").text(r);
				
			}
			function QueryAssetRecord(ZicBh){
				plus.nativeUI.showWaiting("正在查询卡片信息");
				$jqzw_server.callServer('SdSfDxAssetCardInfoAddService','queryAssetCardInfo',ZicBh).success(function(iv){
//						console.log(JSON.stringify(iv));
					if(iv == null || iv == ""){
						plus.nativeUI.closeWaiting();
						mui.toast("未搜索到数据");
						return;
					} 
					
					cardobj = iv;
					$("#zcbhtext").text(iv.zicbh);
					$("#zcmctext").text(iv.zicmc);
					Guigxh(iv.guigxh);
					Snhaoin(iv.chuch);
//					cunfddobj = [{recid: iv.cunfddid, stdname: iv.cunfdd}];
//					$("#cunfddtext").text(cunfddobj[0].stdname);
					plus.nativeUI.closeWaiting();
				}).error(function(iv){
					console.log(iv);
					plus.nativeUI.closeWaiting();
				}).unlogin(function(iv){
					plus.nativeUI.closeWaiting();
					mui.toast("登录超时，可重新进行上一步搜索");
				});
			}
			
			function QueryCunfdd(stdcode){
				plus.nativeUI.showWaiting("正在查询存放地点信息");
				$jqzw_server.callServer('SdSfDxAssetCardInfoAddService','getAssetDepositart',stdcode).success(function(iv){
					if(iv == null || iv == ""){
						mui.toast("未搜索到数据");
						return;
					}
					cunfddobj = iv; 
//					console.log(JSON.stringify(iv));
					$("#cunfddtext").text(iv[0].stdname);
					plus.nativeUI.closeWaiting();
				}).error(function(iv){
					console.log(iv);
					plus.nativeUI.closeWaiting();
				}).unlogin(function(iv){
					plus.nativeUI.closeWaiting();
					mui.toast("登录超时，可重新进行上一步搜索");
				});
			}
			
			function CreateAssetRecord(ZicObj){	
				for(var i=0;i<AssetCards.length;i++){
					if(AssetCards[i].zicbh == ZicObj.zicbh){
						mui.toast("此卡片已存在!");
						return false;
					}
				}
				$("#history").append('<li  class="ditem">'+ZicObj.zicbh+"  "+ZicObj.zicmc+'	</li>')
				AssetCards.push(ZicObj);
			};

			function cleanHistroy(){
				$(".info-value").text("");
				scanType = null;
				cunfddobj = null;
				cardobj = null;
				snhao = null;
			}
		</script>
	</body>

</html>