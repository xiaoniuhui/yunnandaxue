<!--
	作者：369126371@qq.com
	时间：2016-08-18
	描述：资产处置详情
-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>待办详情（借用审批）</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/checkstyle.css" />
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/common.css" />
		<style>
			html,
			body {
				background-color:rgb(239,239,239);
			}
			.mui-pull-left .mui-icon {
				padding-right: 5px;
				font-size: 28px;
			}
			.mui-bottom
			{
			    position: fixed;
			    z-index: 10;
			    right: 0;
			    left: 0;
			
			    height: 44px;
			    padding-right: 10px;
			    padding-left: 10px;
			
			    border-bottom: 0;
			    background-color:rgba(85,85,85,0.6)
			}
			.rightdiv{
				
			}
			.bottomb{
				width: 75px;height: 45px;
				font-size: 18px;
				color: rgb(72,72,72);
			}
			.contonediv{
				width: 94%;
				margin-left: 3%;
				margin-top: 3%;
				float: left;
				
			}
			.worddiv{
				width: 100%;
				float: left;
				
			}
			.divleft{
				float: left;
				width: 45%;
				background-color: #FFFFFF;
				text-indent: 1em;
				font-size: 14px;
				height: 40px;
				overflow: hidden;
				line-height: 40px;
				
			}
			.divright{
				background-color: #FFFFFF;
				float: left;
				width: 55%;
				text-align: right;
				padding-right: 5%;
				font-size: 14px;
				height: 40px;
				overflow: hidden;
				line-height: 40px;
			}
			.hline{
				height: 1px;
				background-color: rgb(239,239,239);
				width: 100%;
				float: left;
			}
			.buttondiv{
				background-color: #FFFFFF;
				float: left;
				width: 100%;
			}
			.buttondiv .divlefts{
				margin-top:13px ;
				padding-left: 15px;
				width: 30%;
				float:left;
			}
			.buttondiv .divrights{
				height: 50px;
				line-height: 50px;
				width: 70%;
				float:left;
				text-align: right;
				padding-right: 5%;
			}
			.buttonto{
				padding: 8px 8px;
				margin-left: 10px;
				margin-top: 6px;
				background-color: rgb(42,195,253);
				color: #FFFFFF;
				border: 1px solid rgb(168,230,254);
				border-radius: 5px;
			}
			.Assettitle{
				float: left;
				width: 100%;
				text-align: left;
				margin-top: 10px;
			}
			.Assetbutton{
				float: left;
				width: 100%;
				text-align: right;
				
			}
			.recid{
				display: none;
			}
			.buttondiv{
				width: 100%;
				height: 50px;
			}
			.buttonwebs{
				width: 98%;
				margin-left: 1%;
				height: 45px;
				background-color: rgb(42,195,253);
				color: #FFFFFF;
				font-size: 18px;
				letter-spacing: 5px;
			}
			/*以下为弹出意见框样式*/
			.approval-info {
				padding: 5px;
			}
			.approval-info .info-title,
			.approval-info .info-value {
				float: left;
				text-align: right;
			}
			.approval-info .info-title {
				width: 40%;
				height: 24px;
				line-height: 24px;
			}
			
			.approval-info .info-value {
				width: 60%;
			}
			
			.approval-info .info-value input,
			.approval-info .info-value textarea {
				margin-bottom: 0px;
				padding: 0 5px;
				font-size: 14px;
			}
			
			.approval-info .info-value input {
				height: 24px;
				line-height: 20px;
			}
		</style>
	</head>

	<body>

		<header id="header" class="mui-bar mui-bar-nav" style="background-color: rgb(44,195,255);">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;">
				<span style="font-size: 15px;"></span>
			</a>
			<h1 class="mui-title" style="color: white;" id="headtextss">待办详情</h1>
		</header>

		<div class="mui-content" style="background-color: #FFFFFF;" id="toShowDisp"></div>
		<div style="height: 85px; float: left;width: 100%;"></div>
		<div class="mui-bottom mui-bar-tab">
			<div >
				<div style="float: left;padding: 12px 5px 8px 15px; ">
					<button class="bottomb"  id="todotoagree">同意</button>
				</div>
				<div style="float: right;padding:  12px 5px 8px 15px;">
					<button class="bottomb"  id="todotodisagree">驳回</button>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/jquery-1.11.3.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jqzw_server.js" ></script>
		<script type="text/javascript" src="../../js/layer/layer.js" ></script>
		<script type="text/javascript">
			var aniShow = "pop-in";
			var disposal = null;
			var biaos = null;
			var biaoming = null;
			var gotohtml = null;
			var dialogCommentId = 'dialog-comment';
			var showFields = null;
			
			mui.init();
			
			mui.plusReady(function(){
				var ViewDetails = plus.webview.getWebviewById("ViewDetails");
				disposal = ViewDetails.DisPosal;
				biaos = ViewDetails.biaos;
				biaoming = ViewDetails.biaoming;
				gotohtml = ViewDetails.html;
				showFields = ViewDetails.showFields;
				
				if(disposal.jied == '1') {
					$('#todotodisagree').hide();
				}
				
				if(gotohtml == "HomeList.html"){
					document.getElementById("headtextss").innerText = ViewDetails.headtext+"待办详情";
				}
				CreateDisapnols(ViewDetails.DisPosal);
				
				document.getElementById("todotoagree").addEventListener('tap', function() {
					agree('同意');
				});
				
				document.getElementById("todotodisagree").addEventListener('tap', function() {
					reject('');
				});
			});
			
			function agree(defaultComment) {
				var content = null;
				var jieyjbr = disposal.BIZ_SDSFDX_JIEYJBR;
				if(typeof jieyjbr !='string' || jieyjbr == null || jieyjbr == 'undefined') {
					jieyjbr = '';
				}
				var readonly = true;
				var commentTitle = '审批意见';
				if(disposal.jied == '1') {
					commentTitle = '借用人意见';
					readonly = false;
				}
				content = '<div class="approval-info">'
					+'<div class="info-title">借用经办人：</div>'
					+'<div class="info-value"><input id="info-jieyjbr" type="text" value="'+jieyjbr+'" '+ (readonly?'readonly="readonly"':"")+'/></div>'
					+'<div class="clear"></div>'
				+'</div>'
				+'<div class="approval-info">'
					+'<div class="info-title">'+commentTitle+'：</div>'
					+'<div class="info-value"><textarea id="' + dialogCommentId + '" rows="3" placeholder="请填写'+commentTitle+'">' + defaultComment + '</textarea></div>'
					+'<div class="clear"></div>'
				+'</div>';
				
				openCommentDialog(content, '同意', function() {
					var jieyjbr = '';
					if(isAssetJieYong) {
						jieyjbr = $.trim($('#info-jieyjbr').val());
						if(jieyjbr == "") {
							mui.toast('借用经办人不能为空！');
							return;
						}
					}
					var commentText = $.trim($("#" + dialogCommentId).val());
					if(commentText == "") {
						mui.toast('请填写审批意见');
						return false;
					}
					approval(disposal.recid, "true", biaos, disposal.ptguid, commentText, jieyjbr);
				});
			}
			
			function reject(defaultComment) {
				var jied = disposal.jied;
				if(jied == '1') {
					mui.toast('当前审批不允许进行驳回操作！');
					return;
				}
					
				var content = '<textarea id="' + dialogCommentId + '" placeholder="请填写审批意见">' + defaultComment + '</textarea>';
				openCommentDialog(content, '', function() {
					var commentText = $.trim($("#" + dialogCommentId).val());
					if(commentText == "") {
						mui.toast("请填写审批意见");
						return false;
					}
					approval(disposal.recid, "false", biaos, disposal.ptguid, commentText, '');
				});
			}
			
			function openCommentDialog(content, defaultValue, callback) {
				if(typeof defaultValue === 'undefined' || defaultValue == null || defaultValue == 'undefined') {
					defaultValue = '';
				}
				layer.open({
					title: '审批',
					content: content,
					shadeClose: false,
					btn: ['确定', '取消'],
					yes: callback
				});
			};
			
			function approval(recid, result, biaos, ptguid, comment, jieyjbr) {
				$jqzw_server.callServer('SdSfDxNeedToDoService','InsertBoolean', recid, result, biaos,ptguid, comment, jieyjbr).success(function(iv){
					if(iv == false || iv== 'false') {
						mui.toast('审批失败！');
					} else {
						mui.toast("完成借物信息确认");
						var ws = plus.webview.getWebviewById(gotohtml);
						if(ws!=null) {
							mui.fire(ws,'refresh', {});
						}
						mui.back();
					}
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					mui.toast("会话过久，可重新进行上次操作"); 
				});
			}
			
			function CreateDisapnols(disposal){ 	
				$("#toShowDisp").html("");
				$("#toShowDisp").append(creatMasterHtml(disposal));
				$jqzw_server.callServer('SdSfDxNeedToDoService','getListDetail',biaoming,disposal.recid).success(function(iv){
					CreateAssetCards(iv);
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					mui.toast("会话过久，可重新进行上次操作"); 
				});
			}
			
			function CreateAssetCards(Assetcards){
				for(var i in Assetcards){
//					console.log("iv:"+JSON.stringify(Assetcards[i]));
					var html = '<div class="contonediv">'
						+'<div class="worddiv">'
							+'<div class="divleft">资产编号</div>'
							+'<div class="divright">'+Assetcards[i].zicbh+'</div>'
						+'</div>'
						+'<div class="worddiv">'
							+'<div class="divleft">资产名称</div><div class="divright">'+Assetcards[i].zicmc+'</div>'
						+'</div>'
						+'<div class="worddiv">'
							+'<div class="divleft">资产类别</div><div class="divright">'+Assetcards[i].zicflname+'</div>'
						+'</div>'
						+'<div class="worddiv">'
							+'<div class="divleft">责任人</div><div class="divright">'+Assetcards[i].BIZ_JY00_SHIYRID+'</div>'
						+'</div>'
						+'<div class="worddiv">'
							+'<div class="divleft">价值</div><div class="divright">'+Assetcards[i].jiaz+'</div>'
						+'</div>'
					+'</div>';
					$("#toShowDisp").append(html);
				}
			}
			
			function creatMasterHtml(disposal) {
				var html = '<div class="contonediv">'
					+'<div class="recid">'+disposal.recid+'</div>';
					
					for(var j=0; j<showFields.length; j++) {
						var fieldName = showFields[j].fieldName
						var fieldValue = disposal[fieldName];
						html += '<div class="worddiv">'
							+'<div class="divleft">'+showFields[j]["fieldTitle"]+'</div>'
							+'<div class="divright">'+fieldValue+'</div></div>';
					}
					html += '<div class="hline"></div>'
					+'<div class="worddiv">'
						+'<div class="Assettitle">资产明细</div>'
					+'</div>'
				+'</div>';
				return html;
			}
		</script>

	</body>

</html>