<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>2016日常盘点任务图表</title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<style>
	body, html
	{
		width:100%;
		height:100%;
		font-family: "微软雅黑";
		overflow-x: hidden;
	}
	.mui-content{
		background:#fff;
		height:100%;
		width:100%;
		overflow-x: hidden;
	}
	.headcount{
		background-color: rgb(95,161,246);
	}
	.chart {
		height: 300px;
	}
	.infodiv{
		margin-left: 2%;
		width: 96%;
		background-color: rgb(231,231,231);
		font-size: 15px;
		color: #999;
	}
	
	.lidivone{
		width: 30%;
		text-align: right;
		float: left;
		background-color: rgb(231,231,231);
		margin-top: 8px;
	}
	.lidivtwo{
		width: 70%;
		float: left;
		background-color: rgb(231,231,231);
		margin-top: 8px;
	}
	
	.buttondiv{
		width: 100%;
		height: 100px;
		margin-top: 10px;
	}
	.buttonwebs{
		width: 96%;
		margin-left: 2%;
		margin-bottom: 5px;
		height: 45px;
		background-color: rgb(85,192,24);
		color: #FFFFFF;
		font-size: 18px;
		letter-spacing: 5px;
	}
	#topPopover {
		width: 150px;
		position: fixed;
		top: 16px;
		right: 6px;
		height: 150px;
		text-align: center;
	}
	.topPopoverdiv{
		line-height: 50px;
		height: 50px;
		width: 100%;
	}
	#topPopover .mui-popover-arrow {
		left: auto;
		right: 6px;
	}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav headcount">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;">
				<span style="font-size: 15px;">返回</span>
			</a>
			<h1 class="mui-title" style="color: #FFFFFF;" id="headtext">实物交接图表展示</h1>
		</header>
		<div class="mui-content">
			<div class="chart" id="pieChart"></div>
			<div class="infodiv">
				<div class="lidivone">任务名称：</div>
				<div class="lidivtwo" id="renwumingcheng">单位调剂任务一</div>
				<div class="lidivone">单据编号：</div>
				<div class="lidivtwo" id="infodiv-billid">&nbsp;</div>
				<div class="lidivone">创建日期：</div>
				<div class="lidivtwo" id="chuangjianshijian">2016-03-09</div>
				<div style="height: 8px; clear: both; background-color: rgb(231,231,231);"></div>
			</div>
			<div class="buttondiv">
				<button class="buttonwebs" onclick="readData()">读一读</button>
				<button class="buttonwebs" onclick="clicked('../base/barcode_scan.html',true,true);">扫一扫</button>
			</div>
		</div>
		
		
		<!--右上角弹出菜单-->
		<div style="display: none;" id="savedate">
			<div id="panNum"></div>
			<div id="weiNum"></div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery-1.11.3.js" ></script>
		<script type="text/javascript" src="../../js/common.js" ></script>
		<script type="text/javascript" src="../../js/jqzw_server.js" ></script>
		<script src="../../js/echarts.min.js"></script>
		<script type="text/javascript" src="../../js/test.js"></script>
		<script type="text/javascript" src="../../js/nfcty.js" ></script>
		<script>
			var aniShow = "pop-in";
			var jiaojiess = null;
			mui.init({
				beforeback: function(){
					//获得列表界面的webview
					var AssetJiaoJie = plus.webview.getWebviewById('AssetJiaoJie');
					//触发列表界面的自定义事件（refresh）,从而进行数据刷新
					mui.fire(AssetJiaoJie,'refresh');
					//返回true，继续页面关闭逻辑
					return true;
				}
			});
			mui.plusReady(function() {
				var Jchartshow = plus.webview.getWebviewById('Jchartshow');
				document.getElementById("renwumingcheng").innerText = Jchartshow.title;
				document.getElementById("chuangjianshijian").innerText = Jchartshow.sj;
				document.getElementById("infodiv-billid").innerText = Jchartshow.billcode;
				
				$jqzw_server.callServer('SdSfDxSolidTransfer','querySolidTransferDetil',Jchartshow.recid).success(function(jiaojies){
					jiaojiess = jiaojies;
					setJiaoJie(jiaojies)
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					console.log(iv);
				}); 
			});
			
			
			function setJiaoJie(jiaojies){
				var panNum = 0;
				var weiNum = 0;
				for(var i=0;i<jiaojies.length;i++){ 
					if(jiaojies[i].isshiwjj){ 
						panNum = panNum+1;
					}else{
						weiNum = weiNum+1;
					}
				};
				drawPie(panNum,weiNum); 
			}

		function drawPie(panNum,weiNum){
			option = {
			    legend: {
			        orient: 'vertical',
			        left:'right',
//			        top:'8%',
			        data: ['已交接','未交接']
			    },
			    color:['rgb(51,198,101)', 'rgb(250,150,3)'],
			    series : [
			        {
			            name: '日常盘点任务',
			            type: 'pie',
			            hoverAnimation:false,
			            radius : '55%',
			            center: ['50%', '50%'],
			            selectedMode: 'single',
			            selectedOffset:0,
			            labelLine: {
			                normal: {
			                    show: false
			                }
			            },
			            data:[
			                {value:panNum, name:'已交接\n\n'+panNum+"个" },
			                {value:weiNum, name:'未交接 \n\n'+weiNum+"个"}
			            ],
			            label: {
			                normal: {
			                    position: 'inner'
			                }
			            },
			            itemStyle: {
			                emphasis: {
			                    shadowBlur: 10,
			                    shadowOffsetX: 0,
			                    shadowColor: 'rgba(0, 0, 0, 0.5)'
			                }
			            }
			        }
			    ]
			};
			var pieChart = echarts.init(document.getElementById('pieChart'));
			pieChart.setOption(option);
			
			pieChart.on('click', function (param) {
			    mui.openWindow({
						url: "Jmingxi.html",
						id:'Jmingxi',
						styles: {
							popGesture: 'close',
							scrollIndicator: "none"
						},
						show: {
							aniShow: aniShow
						},
						waiting: {
							autoShow: true
						},
						extras:{
							canshu:param.name
						}
				});
			});
		}
		
		function scaned( t, r, f ) {
			var d = new Date();
			var h=d.getHours(),m=d.getMinutes(),s=d.getSeconds(),ms=d.getMilliseconds();
			if ( h < 10 ) { h='0'+h; }
			if ( m < 10 ) { m='0'+m; }
			if ( s < 10 ) { s='0'+s; }
			if ( ms < 10 ) { ms='00'+ms; } else if ( ms < 100 ) { ms='0'+ms; }
			var ts = '['+h+':'+m+':'+s+'.'+ms+']';
			zaixianduibi(r);
		}
		function __read(intent){
		    var s = "nono";
		    waiting.setTitle('请勿移开标签\n正在读取数据...');
		    var Parcelable = plus.android.importClass("android.os.Parcelable");
		    var tag = intent.getParcelableExtra(NfcAdapter.EXTRA_TAG);
		    s = pluginGetStringSync(tag);
		    var stringread = s.split(",");
		    var stringif = stringread[0].split("##")
		    zaixianduibi(stringif[1]);
		    waiting.close();
		}
		// 执行完扫描之后进行资产编号的对比。//综合方法
		function zaixianduibi(r){
			//jiaojiess
			var flag = false;
			var index = -1;
			var strings = "此调剂并没有此条资产";
			var indexs = 0;
			for(var i=0;i<jiaojiess.length;i++){ 
				indexs = indexs+1;
				if(jiaojiess[i].zicbh == r){ 
					console.log(r);
					if(jiaojiess[i].isshiwjj){
						strings = "此条资产已交接";
						break;
					}
					index = i;
					
					flag = true;
				}
			};

			if(flag){
				var Jchartshow = plus.webview.getWebviewById('Jchartshow');
				
				var detailRecid = jiaojiess[index].detailrecid;
				var detailDefine = jiaojiess[index].detaildefine
				
				$jqzw_server.callServer('SdSfDxSolidTransfer','updateSolidTransferDetil',r,Jchartshow.recid,jiaojiess[index].cardobjectid, detailRecid, detailDefine).success(function(iv){
					jiaojiess[index].isshiwjj = true;
					if(indexs == jiaojiess.length) {
						$jqzw_server.callServer('SdSfDxSolidTransfer','updateSolidTransferMaster',Jchartshow.recid,Jchartshow.srcRecid,Jchartshow.srcDefineid).success(function(iv){
							mui.toast("此单已完成！")
						}).error(function(iv){
							console.log(iv);
						}).unlogin(function(iv){
							console.log(iv);
						});
					}
					setJiaoJie(jiaojiess);
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					console.log(iv);
				});
			}else{
				mui.toast(strings)
				setJiaoJie(jiaojiess);
			}
		}
		</script>
	</body>
</html>
