<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>2016日常盘点任务图表</title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/common.css" />
		<style>
	body, html
	{
		width:100%;
		height:100%;
		font-family: "微软雅黑";
		overflow-x: hidden;
	}
	.mui-content{
		background:#fff;
		height:100%;
		width:100%;
		overflow-x: hidden;
	}
	.headcount{
		background-color: rgb(95,161,246);
	}
	.chart 
	{
		height: 300px;
	}
	.infodiv{
		margin-left: 2%;
		width: 96%;
		background-color: rgb(231,231,231);
		font-size: 15px;
		color: #999;
	}
	
	.lidivone{
		width: 30%;
		text-align: right;
		float: left;
		background-color: rgb(231,231,231);
		margin-top: 8px;
	}
	.lidivtwo{
		width: 70%;
		float: left;
		background-color: rgb(231,231,231);
		margin-top: 8px;
	}
	
	.buttondiv{
		margin-top: 10px;
		width: 100%;
	}
	.btn-group {
		margin: 5px;
	}
	.btn-group-title {
		height: 31px;
		line-height: 31px;
	}
	.btn-group-btn {
		background-color: rgb(85,192,24);
		color: #FFFFFF;
		border: none;
	}
	#topPopover {
		width: 150px;
		position: fixed;
		top: 16px;
		right: 6px;
		height: 100px;
		text-align: center;
	}
	.topPopoverdiv{
		line-height: 50px;
		height: 50px;
		width: 100%;
	}
	#topPopover .mui-popover-arrow {
		left: auto;
		right: 6px;
	}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav headcount">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;">
					<span style="font-size: 15px;">返回</span>
				</a>
				<!--<a id="menu" href="#topPopover" class="mui-action-menu mui-icon mui-icon-bars mui-pull-right" style="color: white;"></a>-->
				<h1 class="mui-title" style="color: #FFFFFF;" id="headtext">盘点明细</h1>
			</header>
		<div class="mui-content">
			<div class="chart" id="pieChart"></div>
			<div class="infodiv">
				<div class="lidivone">任务名称：</div>
				<div class="lidivtwo" id="renwumingcheng">&nbsp;</div>
				<div class="lidivone">存放地点：</div>
				<div class="lidivtwo" id="infodiv-cunfdd">&nbsp;</div>
				<div class="lidivone">创建日期：</div>
				<div class="lidivtwo" id="chuangjianshijian">&nbsp;</div>
				<div style="height: 8px; clear: both; background-color: rgb(231,231,231);"></div>
			</div>
			<div class="buttondiv">
				<div class="btn-group">
					<span class="btn-group-title">存放地点：</span>
					<button class="btn-group-btn" id="btn-cunfdd-scan">扫一扫</button>
					<button class="btn-group-btn" id="btn-cunfdd-read">读一读</button>
				</div>
				<div class="btn-group">
					<span class="btn-group-title">资产卡片：</span>
					<button class="btn-group-btn" id="btn-asset-scan">扫一扫</button>
					<button class="btn-group-btn" id="btn-asset-read">读一读</button>
				</div>
			</div>
		</div>
		
		
		<!--右上角弹出菜单-->
		<!--
		<div id="topPopover" class="mui-popover">
			<div class="topPopoverdiv" id="topPopoverdiv">盘盈录入</div>
			<div class="topPopoverdiv" id="DownBaseData">下载/更新基础数据</div>
		</div>
		-->
		<div style="display: none;" id="savedate">
			<div id="panNum"></div>
			<div id="weiNum"></div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery-1.11.3.js" ></script>
		<script type="text/javascript" src="../../js/common.js" ></script>
		<script type="text/javascript" src="../../js/jqzw_server.js" ></script>
		<script src="../../js/echarts.min.js"></script>
		<script type="text/javascript" src="../../js/test.js"></script>
		<script type="text/javascript" src="../../js/nfcty.js" ></script>
		<script>
			var aniShow = "pop-in";
			var scanType = null;
			var readType = null;
			var pandianss = null;
			var cunfddId = null;
			mui.init({
				beforeback: function(){
					//获得列表界面的webview
					var AssetsInventory = plus.webview.getWebviewById('AssetsInventory');
					//触发列表界面的自定义事件（refresh）,从而进行数据刷新
					mui.fire(AssetsInventory,'refresh');
					//返回true，继续页面关闭逻辑
					return true;
				}
			});
			window.addEventListener('refreshs',function(event){
			  //获得事件参数; 
			  $(function(){
			  	var chartshow = plus.webview.getWebviewById('chartshow');
				document.getElementById("renwumingcheng").innerText = chartshow.title;
				document.getElementById("chuangjianshijian").innerText = chartshow.sj;
				$jqzw_server.callServer('SdSfDxAssetInventory','getSchemeDetail',chartshow.recid).success(function(jiaojies){
					pandianss = jiaojies;
					setPanDian(jiaojies)
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					console.log(iv);
				}); 
			 });
			});
			mui.plusReady(function() {
				var chartshow = plus.webview.getWebviewById('chartshow');
				document.getElementById("renwumingcheng").innerText = chartshow.title;
				document.getElementById("chuangjianshijian").innerText = chartshow.sj;
				$jqzw_server.callServer('SdSfDxAssetInventory','getSchemeDetail',chartshow.recid).success(function(jiaojies){
					pandianss = jiaojies;
					setPanDian(jiaojies)
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					console.log(iv);
				});
				
				document.getElementById("btn-cunfdd-read").addEventListener('tap', function() {
					readType = 'cunfdd';
					readData();
				});
				document.getElementById("btn-cunfdd-scan").addEventListener('tap', function() {
					scanType = 'cunfdd';
					clicked('../base/barcode_scan.html',true,true);
				});
				document.getElementById("btn-asset-read").addEventListener('tap', function() {
					if(cunfddId === null) {
						mui.toast('请先选择存放地点！');
						return;
					}
					readType = 'asset';
					readData();
				});
				document.getElementById("btn-asset-scan").addEventListener('tap', function() {
					if(cunfddId === null) {
						mui.toast('请先选择存放地点！');
						return;
					}
					scanType = 'asset';
					clicked('../base/barcode_scan.html',true,true);
				});
			});
			
			$(function(){
				$("#topPopoverdiv").click(function(){
					mui.openWindow({
							
						url: "PyLuru.html",
						id:'PyLuru',
						styles: {
							popGesture: 'close',
							scrollIndicator: "none"
						},
						show: {
							aniShow: aniShow
						},
						waiting: {
							autoShow: true
						}
					});
				})
			});
			function setPanDian(jiaojies){
				var panNum = 0;
				var weiNum = 0;
				for(var i=0;i<jiaojies.length;i++){ 
					if(jiaojies[i].isChecked){ 
						panNum = panNum+1;
					}else{
						weiNum = weiNum+1;
					}
				};
				drawPie(panNum,weiNum); 
			}

		function drawPie(panNum,weiNum){
			option = {
			    legend: {
			        orient: 'vertical',
			        left:'right',
			        top:'8%',
			        data: ['盘点','未盘点']
			    },
			    color:['rgb(51,198,101)', 'rgb(250,150,3)'],
			    series : [
			        {
			            name: '日常盘点任务',
			            type: 'pie',
			            hoverAnimation:false,
			            radius : '55%',
			            center: ['50%', '50%'],
			            selectedMode: 'single',
			            selectedOffset:0,
			            labelLine: {
			                normal: {
			                    show: false
			                }
			            },
			            data:[
			                {value:panNum, name:'盘点\n\n'+panNum+"个" },
			                {value:weiNum, name:'未盘点 \n\n'+weiNum+"个"}
			            ],
			            label: {
			                normal: {
			                    position: 'inner'
			                }
			            },
			            itemStyle: {
			                emphasis: {
			                    shadowBlur: 10,
			                    shadowOffsetX: 0,
			                    shadowColor: 'rgba(0, 0, 0, 0.5)'
			                }
			            }
			        }
			    ]
			};
			var pieChart = echarts.init(document.getElementById('pieChart'));
			pieChart.setOption(option);
			 
			pieChart.on('click', function (param) {
				var type = param.name;
				if(type.indexOf("未盘点")===-1) {
					type = '无盈亏';
				}
			    mui.openWindow({
						url: "mingxi.html",
						id:'mingxi',
						styles: {
							popGesture: 'close',
							scrollIndicator: "none"
						},
						show: {
							aniShow: aniShow
						},
						waiting: {
							autoShow: true
						},
						extras:{
							canshu:type
						}
				});
			});
		}
		
		function scaned( t, r, f ) {
			if(scanType === 'asset') {
		    	zaixianduibi(r);
		    } else if(scanType === 'cunfdd') {
		    	queryCunfdd(r);
		    }
		}
		
		function __read(intent){
		    var s = "nono";
		    waiting.setTitle('请勿移开标签\n正在读取数据...');
		    var Parcelable = plus.android.importClass("android.os.Parcelable");
		    var tag = intent.getParcelableExtra(NfcAdapter.EXTRA_TAG);
		    s = pluginGetStringSync(tag);
		    if(scanType === 'asset') {
		    	var stringread = s.split(",");
			    var stringif = stringread[0].split("##");
			    zaixianduibi(stringif[1]);
		    } else if(scanType === 'cunfdd') {
		    	queryCunfdd(s);
		    }
		    waiting.close();
		}
		
		function queryCunfdd(stdcode) {
			$jqzw_server.callServer('SdSfDxAssetCardInfoAddService','getAssetDepositart',stdcode).success(function(iv){
				if(iv == null || iv == ""){
					mui.toast("未搜索到数据");
					return;
				}
				cunfddId = iv[0].recid;
				$("#infodiv-cunfdd").text(iv[0].stdname);
			}).error(function(iv){
				console.log(iv);
			}).unlogin(function(iv){
				mui.toast("登录超时，可重新进行上一步搜索");
			});
		}
		
		// 执行完扫描之后进行资产编号的对比。//综合方法
		function zaixianduibi(r){
			//pandianss
			var flag = false;
			var index = -1;
			var strings = "此盘点并没有此条资产";
			var indexs = 0;
			for(var i=0;i<pandianss.length;i++){ 
				indexs = indexs+1;
				if(pandianss[i].zicbh == r){ 
					if(pandianss[i].isChecked){
						strings = "此条资产已交接";
						break;
					}
					index = i;
					
					flag = true;
				}
			};

			if(flag){
				var chartshow = plus.webview.getWebviewById('chartshow');
				var objects = [pandianss[index].recid];
				var cardobjects = [pandianss[index].cardObjectId];
				objects.push();
				//TODO 应该将存放地点也传个服务端
				$jqzw_server.callServer('SdSfDxAssetInventory','updateSchemeDetailAndCardInfo',chartshow.recid,JSON.stringify(objects),JSON.stringify(cardobjects),"01").success(function(iv){ 
					pandianss[index].isChecked = true;
					/*if(indexs == pandianss.length){
						$jqzw_server.callServer('SdSfDxAssetInventory','updateSolidTransferMaster',chartshow.recid).success(function(iv){ 
							mui.toast("此单已完成！")
						}).error(function(iv){ 
							console.log(iv);
						}).unlogin(function(iv){
							console.log(iv);
						});
					}*/
					//console.log(JSON.stringify(iv))
					setPanDian(pandianss);
				}).error(function(iv){
					console.log(iv);
				}).unlogin(function(iv){
					console.log(iv);
				});
			}else{
				mui.toast(strings)
				setPanDian(pandianss);
			}
		}
		</script>
	</body>
</html>
